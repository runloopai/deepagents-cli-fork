# Dockerfile for building Linux runtime package with fixed shebangs
FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    make \
    && rm -rf /var/lib/apt/lists/*

# Install uv
RUN pip install uv

# Copy project files
COPY pyproject.toml uv.lock README.md ./
COPY deepagents_cli/ ./deepagents_cli/
COPY fix-venv-shebangs.sh run.sh ./

# Create virtual environment and install dependencies
RUN uv sync --frozen

# Fix shebangs to make venv relocatable
RUN chmod +x fix-venv-shebangs.sh && \
    ./fix-venv-shebangs.sh .venv

# Make run.sh executable
RUN chmod +x run.sh

# Create the runtime tarball
RUN tar -czf /deepagents-cli-runtime-linux.tar.gz \
    --exclude='*.pyc' \
    --exclude='*.pyo' \
    --exclude='__pycache__' \
    --exclude='.DS_Store' \
    deepagents_cli/ \
    .venv/ \
    pyproject.toml \
    uv.lock \
    README.md \
    run.sh

CMD ["bash"]
